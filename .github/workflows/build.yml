name: Build Vial QMK Firmware # Vial対応ファームウェアを作成
on:
  push:
    branches:
      - main # mainブランチにpushされたときに実行
  workflow_dispatch: # Actionsタブから手動で実行できるようにする

# 変数をenvセクションで定義
env:
  KEYBOARD_NAME: "tomtho" # キーボードの名前
  KEYMAP_NAME: "vial" # ビルドするキーマップの名前 (例: vial, defaultなど)

jobs:
  build:
    runs-on: ubuntu-latest
    container: qmkfm/qmk_cli:latest # QMK CLI環境を使用
    steps:
      # Vial対応QMKを取得
      - name: Checkout Vial QMK Firmware
        uses: actions/checkout@v4
        with:
          repository: vial-kb/vial-qmk
          path: vial-qmk

      # 自作リポジトリをチェックアウト
      - name: Checkout user repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          path: user_repo

      # 自作キーボードフォルダをVial QMKにリンク
      - name: Link custom keyboard
        id: link_keyboard # ステップにIDを設定
        run: |
          # QMKの標準的なフォルダ構成を前提にパスを決定
          KEYBOARD_PATH_IN_REPO="qmk_firmware/keyboards/${{ env.KEYBOARD_NAME }}"
          # リポジトリのルートに keyboards フォルダがある場合をチェック
          if [ -d "$(pwd)/user_repo/keyboards/${{ env.KEYBOARD_NAME }}" ]; then
            KEYBOARD_PATH_IN_REPO="keyboards/${{ env.KEYBOARD_NAME }}"
          fi
          
          # シンボリックリンクを作成
          ln -s "$(pwd)/user_repo/${KEYBOARD_PATH_IN_REPO}" \
          "$(pwd)/vial-qmk/keyboards/${{ env.KEYBOARD_NAME }}"
          
          # ビルド成果物のパスをステップ出力として設定
          echo "firmware_path=vial-qmk/${{ env.KEYBOARD_NAME }}_${{ env.KEYMAP_NAME }}" >> $GITHUB_OUTPUT

      # ビルドとアップロードをまとめて行う
      - name: Build and Upload Vial firmware
        working-directory: vial-qmk
        run: |
          make ${{ env.KEYBOARD_NAME }}:${{ env.KEYMAP_NAME }}
        
      # 成果物をアップロード（.uf2 / .hex / .bin）
      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KEYBOARD_NAME }}-${{ env.KEYMAP_NAME }}-firmware
          # working-directoryがvial-qmkなので、パスはシンプルに
          path: ${{ env.KEYBOARD_NAME }}_${{ env.KEYMAP_NAME }}.uf2
                ${{ env.KEYBOARD_NAME }}_${{ env.KEYMAP_NAME }}.hex
                ${{ env.KEYBOARD_NAME }}_${{ env.KEYMAP_NAME }}.bin
