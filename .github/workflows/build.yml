name: Build Vial QMK Firmware # Vial対応ファームウェアを作成
on:
  push:
    branches:
      - main # mainブランチにpushされたときに実行
  workflow_dispatch: # Actionsタブから手動で実行できるようにする

jobs:
  find_keyboards:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set_matrix.outputs.matrix }}
    steps:
      - name: Checkout user repo
        uses: actions/checkout@v4
        with:
          path: user_repo

      - name: Find and extract keyboard info
        id: set_matrix
        run: |
          # user_repo/以下のvial.jsonをすべて検索
          find_result=$(find user_repo/ -name 'vial.json' -print0)
          
          # findの結果をNULL文字で区切り、jqで処理
          # jqで各vial.jsonから"name"の値を抽出し、JSONオブジェクトの配列に変換
          # xargsに複数のファイルパスが渡された場合でも適切に処理
          # エラーが発生しても空の配列を返すようにする
          json_matrix=$(echo "$find_result" | xargs -0 jq -s 'map({vial_json_path: . , keyboard_name: (. | fromjson | .name)})' 2>/dev/null || echo "[]")

          # 複数行の出力を正しく扱うために、ヒアドキュメントを使用
          echo "matrix<<EOF" >> $GITHUB_OUTPUT
          echo "$json_matrix" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  build:
    runs-on: ubuntu-latest
    needs: find_keyboards
    strategy:
      matrix: ${{ fromJson(needs.find_keyboards.outputs.matrix) }}
    container: qmkfm/qmk_cli:latest
    
    steps:
      - name: Checkout Vial QMK Firmware
        uses: actions/checkout@v4
        with:
          repository: vial-kb/vial-qmk
          path: vial-qmk

      - name: Checkout user repo
        uses: actions/checkout@v4
        with:
          path: user_repo

      - name: Link custom keyboard
        run: |
          # dirnameコマンドでvial.jsonの親ディレクトリを抽出し、USER_REPO_PATH環境変数に格納
          USER_REPO_PATH=$(dirname "${{ matrix.vial_json_path }}")
          
          # 抽出したパスを使ってシンボリックリンクを作成
          ln -s "$(pwd)/user_repo/${USER_REPO_PATH}" \
          "$(pwd)/vial-qmk/keyboards/${{ matrix.keyboard_name }}"
      
      - name: Build Vial firmware
        working-directory: vial-qmk
        run: |
          make ${{ matrix.keyboard_name }}:vial
      
      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.keyboard_name }}-vial-firmware
          path: |
            vial-qmk/${{ matrix.keyboard_name }}_vial.uf2
            vial-qmk/${{ matrix.keyboard_name }}_vial.hex
            vial-qmk/${{ matrix.keyboard_name }}_vial.bin
