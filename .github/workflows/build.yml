name: Build Vial QMK Firmware  # Vial対応ファームウェアを作成

on:
  push:
    branches:
      - main  # mainブランチにpushされたときに実行

jobs:
  build:
    runs-on: ubuntu-latest
    container: vialkeyboard/qmk_cli  # Vial公式のQMK CLI環境を使用

    steps:
      # Vial対応QMKを取得
      - name: Checkout Vial QMK Firmware
        uses: actions/checkout@v4
        with:
          repository: vial-kb/vial-qmk  # 通常のQMKではなくVial版を使用
          path: vial-qmk

      # 自作リポジトリをチェックアウト
      - name: Checkout user repo (tomtho-akdk/qmk.tomtho)
        uses: actions/checkout@v4
        with:
          path: user_repo

      # 自作キーボードフォルダをVial QMKにリンク
      - name: Link custom keyboard
        run: |
          ln -s $(pwd)/user_repo/tomtho-akdk/qmk_firmware/keyboards/tomtho \
                $(pwd)/vial-qmk/keyboards/tomtho

      # ファームウェアをビルド
      - name: Build Vial firmware
        working-directory: vial-qmk
        run: |
          make tomtho:vial

      # 成果物をアップロード（.uf2 / .hex / .bin）
      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: tomtho-vial-firmware
          path: |
            vial-qmk/tomtho_vial.uf2
            vial-qmk/tomtho_vial.hex
            vial-qmk/tomtho_vial.bin
