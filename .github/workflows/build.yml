name: Build QMK and Vial Firmware
on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  KEYBOARD_NAME: "tomtho"
  USER_REPO_PATH: "tomtho-akdk/keyboards/tomtho"  # â† å®Ÿéš›ã®æ§‹æˆã«åˆã‚ã›ã¦ä¿®æ­£ï¼

jobs:
  # ======================================
  # ğŸ”¹ Vial QMKç‰ˆãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã®ãƒ“ãƒ«ãƒ‰
  # ======================================
  build_vial:
    name: Build Vial Firmware
    runs-on: ubuntu-latest
    container: qmkfm/qmk_cli:latest

    steps:
      - name: Checkout Vial QMK
        uses: actions/checkout@v4
        with:
          repository: vial-kb/vial-qmk
          path: vial-qmk

      - name: Checkout user repo
        uses: actions/checkout@v4
        with:
          path: user_repo

      - name: Copy custom keyboard (instead of symlink)
        run: |
          mkdir -p vial-qmk/keyboards/${{ env.KEYBOARD_NAME }}
          cp -r user_repo/${{ env.USER_REPO_PATH }}/* \
                vial-qmk/keyboards/${{ env.KEYBOARD_NAME }}/
          echo "âœ… Copied custom keyboard files."

      - name: Build Vial firmware
        working-directory: vial-qmk
        run: |
          make ${{ env.KEYBOARD_NAME }}:vial || (echo "âŒ Build failed" && exit 1)
          echo "=== Build Complete ==="
          find .build -type f \( -name "*.uf2" -o -name "*.hex" -o -name "*.bin" \) -print

      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          find vial-qmk/.build -type f \( -name "${{ env.KEYBOARD_NAME }}_vial.*" -o -name "*.hex" -o -name "*.bin" -o -name "*.uf2" \) -exec cp {} artifacts/ \; || true

      - name: Upload Vial firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KEYBOARD_NAME }}-vial-firmware
          path: artifacts/

  # ======================================
  # ğŸ”¹ é€šå¸¸QMKç‰ˆãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã®ãƒ“ãƒ«ãƒ‰
  # ======================================
  build_qmk:
    name: Build QMK Firmware
    runs-on: ubuntu-latest
    container: qmkfm/qmk_cli:latest

    steps:
      - name: Checkout QMK
        uses: actions/checkout@v4
        with:
          repository: qmk/qmk_firmware
          path: qmk

      - name: Checkout user repo
        uses: actions/checkout@v4
        with:
          path: user_repo

      - name: Copy custom keyboard (instead of symlink)
        run: |
          mkdir -p qmk/keyboards/${{ env.KEYBOARD_NAME }}
          cp -r user_repo/${{ env.USER_REPO_PATH }}/* \
                qmk/keyboards/${{ env.KEYBOARD_NAME }}/
          echo "âœ… Copied custom keyboard files."

      - name: Build QMK firmware
        working-directory: qmk
        run: |
          make ${{ env.KEYBOARD_NAME }}:default || (echo "âŒ Build failed" && exit 1)
          echo "=== Build Complete ==="
          find .build -type f \( -name "*.uf2" -o -name "*.hex" -o -name "*.bin" \) -print

      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          find qmk/.build -type f \( -name "${{ env.KEYBOARD_NAME }}_default.*" -o -name "*.hex" -o -name "*.bin" -o -name "*.uf2" \) -exec cp {} artifacts/ \; || true

      - name: Upload QMK firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KEYBOARD_NAME }}-qmk-firmware
          path: artifacts/
