name: Build QMK & Vial Firmware
on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  KEYBOARD_NAME: "tomtho"
  QMK_KEYMAP: "tomtho"
  VIAL_KEYMAP: "vial"
  USER_REPO_PATH: "tomtho-akdk/qmk_firmware/keyboards/tomtho"  # adjust if different

jobs:
  # --------------------------------------
  # QMK: build standard QMK firmware (from repo keymap)
  # --------------------------------------
  build_qmk:
    name: Build QMK Firmware
    runs-on: ubuntu-latest
    container: qmkfm/qmk_cli:latest

    steps:
      - name: Checkout repository (user QMK firmware)
        uses: actions/checkout@v4
        with:
          path: qmk_firmware

      - name: Show qmk directory
        run: |
          echo "Files at repo root:"
          ls -la

      - name: Set up QMK environment
        run: |
          cd qmk_firmware
          # initialize qmk cli environment
          qmk setup --yes

      - name: Build QMK firmware (.hex/.uf2/.bin)
        working-directory: qmk_firmware
        run: |
          echo "üîπ Building QMK firmware: keyboard=${{ env.KEYBOARD_NAME }}, keymap=${{ env.QMK_KEYMAP }}"
          qmk compile -kb ${{ env.KEYBOARD_NAME }} -km ${{ env.QMK_KEYMAP }} || (echo "‚ùå QMK Build failed" && exit 1)
          echo "=== QMK Build Complete ==="
          find . -type f \( -name "*.hex" -o -name "*.bin" -o -name "*.uf2" \) -print || true

      - name: Collect QMK artifacts
        working-directory: qmk_firmware
        run: |
          mkdir -p artifacts
          # copy from .build (qmk cli) or other outputs
          find . -type f \( -path "./.build/*" -o -name "*.hex" -o -name "*.bin" -o -name "*.uf2" \) -exec cp {} artifacts/ \; || true
          echo "Artifacts:"
          ls -la artifacts || true

      - name: Upload QMK firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KEYBOARD_NAME }}-qmk-firmware
          path: qmk_firmware/artifacts/

  # --------------------------------------
  # Vial: build using vial-qmk repo (copy keyboard into vial-qmk/keyboards/)
  # --------------------------------------
  build_vial:
    name: Build Vial Firmware
    runs-on: ubuntu-latest
    container: qmkfm/qmk_cli:latest

    steps:
      - name: Checkout Vial QMK repository
        uses: actions/checkout@v4
        with:
          repository: vial-kb/vial-qmk
          path: vial-qmk

      - name: Checkout user repository (source QMK files)
        uses: actions/checkout@v4
        with:
          path: user_repo

      - name: Copy custom keyboard into vial-qmk (instead of symlink)
        run: |
          set -e
          echo "Copying keyboard files from user_repo/${{ env.USER_REPO_PATH }} to vial-qmk/keyboards/${{ env.KEYBOARD_NAME }}"
          mkdir -p vial-qmk/keyboards/${{ env.KEYBOARD_NAME }}
          cp -r user_repo/${{ env.USER_REPO_PATH }}/* vial-qmk/keyboards/${{ env.KEYBOARD_NAME }}/
          echo "‚úÖ Copied custom keyboard files for Vial."

      - name: Build Vial firmware (make keyboard:vial)
        working-directory: vial-qmk
        run: |
          echo "üîπ Building Vial firmware..."
          make ${{ env.KEYBOARD_NAME }}:vial || (echo "‚ùå Vial Build failed" && exit 1)
          echo "=== Vial Build Complete ==="
          find . -type f \( -name "${{ env.KEYBOARD_NAME }}_vial.*" -o -name "*.hex" -o -name "*.bin" -o -name "*.uf2" \) -print || true

      - name: Collect Vial artifacts
        working-directory: vial-qmk
        run: |
          mkdir -p artifacts
          find . -type f \( -name "${{ env.KEYBOARD_NAME }}_vial.*" -o -name "*.hex" -o -name "*.bin" -o -name "*.uf2" \) -exec cp {} artifacts/ \; || true
          echo "Artifacts:"
          ls -la artifacts || true

      - name: Upload Vial firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KEYBOARD_NAME }}-vial-firmware
          path: vial-qmk/artifacts/
