name: Build QMK and Vial Firmware
on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  KEYBOARD_NAME: "tomtho"
  USER_REPO_PATH: "tomtho-akdk/qmk_firmware/keyboards/tomtho"

jobs:
  # ======================================
  # üîπ Vial QMKÁâà„Éï„Ç°„Éº„É†„Ç¶„Çß„Ç¢„ÅÆ„Éì„É´„Éâ
  # ======================================
  build_vial:
    name: Build Vial Firmware
    runs-on: ubuntu-latest
    container: qmkfm/qmk_cli:latest

    steps:
      - name: Checkout Vial QMK
        uses: actions/checkout@v4
        with:
          repository: vial-kb/vial-qmk
          path: /__w/qmk-tomtho/qmk-tomtho/vial-qmk

      - name: Checkout user repo
        uses: actions/checkout@v4
        with:
          path: /__w/qmk-tomtho/qmk-tomtho/user_repo

      - name: Link custom keyboard
        run: |
          ln -s "/__w/qmk-tomtho/qmk-tomtho/user_repo/${{ env.USER_REPO_PATH }}" \
                "/__w/qmk-tomtho/qmk-tomtho/vial-qmk/keyboards/${{ env.KEYBOARD_NAME }}"

      - name: Build Vial firmware
        working-directory: /__w/qmk-tomtho/qmk-tomtho/vial-qmk
        run: |
          make ${{ env.KEYBOARD_NAME }}:vial
          echo "=== Build Complete ==="
          ls -lh /__w/qmk-tomtho/qmk-tomtho/vial-qmk/.build/

      - name: Copy firmware to root
        run: |
          cp /__w/qmk-tomtho/qmk-tomtho/vial-qmk/.build/${{ env.KEYBOARD_NAME }}_vial.* /__w/qmk-tomtho/qmk-tomtho/

      - name: Upload Vial firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KEYBOARD_NAME }}-vial-firmware
          path: |
            /__w/qmk-tomtho/qmk-tomtho/${{ env.KEYBOARD_NAME }}_vial.uf2
            /__w/qmk-tomtho/qmk-tomtho/${{ env.KEYBOARD_NAME }}_vial.hex
            /__w/qmk-tomtho/qmk-tomtho/${{ env.KEYBOARD_NAME }}_vial.bin

  # ======================================
  # üîπ ÈÄöÂ∏∏QMKÁâà„Éï„Ç°„Éº„É†„Ç¶„Çß„Ç¢„ÅÆ„Éì„É´„Éâ
  # ======================================
  build_qmk:
    name: Build QMK Firmware
    runs-on: ubuntu-latest
    container: qmkfm/qmk_cli:latest

    steps:
      - name: Checkout QMK
        uses: actions/checkout@v4
        with:
          repository: qmk/qmk_firmware
          path: /__w/qmk-tomtho/qmk-tomtho/qmk

      - name: Checkout user repo
        uses: actions/checkout@v4
        with:
          path: /__w/qmk-tomtho/qmk-tomtho/user_repo

      - name: Link custom keyboard
        run: |
          ln -s "/__w/qmk-tomtho/qmk-tomtho/user_repo/${{ env.USER_REPO_PATH }}" \
                "/__w/qmk-tomtho/qmk-tomtho/qmk/keyboards/${{ env.KEYBOARD_NAME }}"

      - name: Build QMK firmware
        working-directory: /__w/qmk-tomtho/qmk-tomtho/qmk
        run: |
          make ${{ env.KEYBOARD_NAME }}:default
          echo "=== Build Complete ==="
          ls -lh /__w/qmk-tomtho/qmk-tomtho/qmk/.build/

      - name: Copy firmware to root
        run: |
          cp /__w/qmk-tomtho/qmk-tomtho/qmk/.build/${{ env.KEYBOARD_NAME }}_default.* /__w/qmk-tomtho/qmk-tomtho/

      - name: Upload QMK firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KEYBOARD_NAME }}-qmk-firmware
          path: |
            /__w/qmk-tomtho/qmk-tomtho/${{ env.KEYBOARD_NAME }}_default.uf2
            /__w/qmk-tomtho/qmk-tomtho/${{ env.KEYBOARD_NAME }}_default.hex
            /__w/qmk-tomtho/qmk-tomtho/${{ env.KEYBOARD_NAME }}_default.bin
