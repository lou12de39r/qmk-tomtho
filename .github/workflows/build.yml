name: Build QMK & Vial Firmware
on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  KEYBOARD_NAME: "tomtho"
  QMK_KEYMAP: "tomtho"
  VIAL_KEYMAP: "vial"
  USER_REPO_PATH: "tomtho-akdk/qmk_firmware/keyboards/tomtho"

jobs:
  build_qmk:
    name: Build QMK Firmware
    runs-on: ubuntu-latest
    container: qmkfm/qmk_cli:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Prepare QMK folder
        run: |
          echo "üß© Copying keyboard folder to QMK directory..."
          mkdir -p qmk_firmware/keyboards/${{ env.KEYBOARD_NAME }}
          cp -r repo/${{ env.USER_REPO_PATH }}/* qmk_firmware/keyboards/${{ env.KEYBOARD_NAME }}/
          echo "‚úÖ Copied tomtho sources"
          ls -R qmk_firmware/keyboards/${{ env.KEYBOARD_NAME }} | head -n 40

      - name: Verify keyboard files
        run: |
          if [ ! -f "qmk_firmware/keyboards/${{ env.KEYBOARD_NAME }}/keyboard.json" ]; then
            echo "‚ùå keyboard.json not found in keyboard folder!"
            exit 1
          fi
          if [ ! -d "qmk_firmware/keyboards/${{ env.KEYBOARD_NAME }}/keymaps/${{ env.QMK_KEYMAP }}" ]; then
            echo "‚ùå keymaps/${{ env.QMK_KEYMAP }} not found!"
            exit 1
          fi
          echo "‚úÖ Folder structure OK"

      - name: Initialize QMK environment
        working-directory: qmk_firmware
        run: |
          qmk setup --yes
          echo "üîç QMK info check:"
          qmk info -kb keyboards/tomtho/keyboard.json || true

      - name: Build QMK firmware
        run: |
          echo "üîπ Building QMK firmware..."
          qmk compile -kb keyboards/tomtho/keyboard.json -km tomtho || (echo "‚ùå QMK Build failed" && exit 1)
          echo "=== QMK Build Complete ==="

      - name: Upload artifacts   # ‚úÖ ‚Üê „Ç§„É≥„Éá„É≥„Éà‰øÆÊ≠£Ê∏à„ÅøÔºÅ
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KEYBOARD_NAME }}-qmk-firmware
          path: qmk_firmware/.build
