name: Build Vial QMK Firmware # Vial対応ファームウェアを作成
on:
  push:
    branches:
      - main # mainブランチにpushされたときに実行
  workflow_dispatch: # Actionsタブから手動で実行できるようにする

jobs:
  find_keyboards:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set_matrix.outputs.matrix }}
    steps:
      - name: Checkout user repo
        uses: actions/checkout@v4
        with:
          path: user_repo

      - name: Find all vial.json paths
        id: set_matrix
        run: |
          # user_repo/以下のvial.jsonをすべて検索し、パスのリストをJSON形式で生成
          find_result=$(find user_repo/ -name 'vial.json' -print0 | jq -Rs 'split("\u0000")[:-1] | map({vial_json_path: .})')
          
          # 複数行の出力を正しく扱うために、ヒアドキュメントを使用
          # この形式は、GitHub Actionsの新しい出力方法に対応
          echo "matrix<<EOF" >> $GITHUB_OUTPUT
          echo "$find_result" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT


  build:
    runs-on: ubuntu-latest
    needs: find_keyboards
    strategy:
      matrix: ${{ fromJson(needs.find_keyboards.outputs.matrix) }}
    container: qmkfm/qmk_cli:latest
    
    steps:
      - name: Checkout Vial QMK Firmware
        uses: actions/checkout@v4
        with:
          repository: vial-kb/vial-qmk
          path: vial-qmk

      - name: Checkout user repo
        uses: actions/checkout@v4
        with:
          path: user_repo

      - name: Get keyboard info from vial.json
        id: get_info
        run: |
          # matrixから渡されたvial.jsonのパスを取得
          VIAL_JSON_PATH="${{ matrix.vial_json_path }}"
          
          # jqを使ってvial.jsonからキーボード名を取得
          KEYBOARD_NAME=$(jq -r '.name' "$VIAL_JSON_PATH")

          if [ -z "$KEYBOARD_NAME" ]; then
            echo "Error: 'name' key not found in $VIAL_JSON_PATH."
            exit 1
          fi

          # 環境変数に設定
          echo "KEYBOARD_NAME=$KEYBOARD_NAME" >> $GITHUB_ENV
          echo "USER_REPO_PATH=$(dirname "$VIAL_JSON_PATH" | sed 's|^user_repo/||')" >> $GITHUB_ENV

      - name: Link custom keyboard
        run: |
          ln -s "$(pwd)/user_repo/${{ env.USER_REPO_PATH }}" \
          "$(pwd)/vial-qmk/keyboards/${{ env.KEYBOARD_NAME }}"
      
      - name: Build Vial firmware
        working-directory: vial-qmk
        run: |
          make ${{ env.KEYBOARD_NAME }}:vial
      
      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KEYBOARD_NAME }}-vial-firmware
          path: |
            vial-qmk/${{ env.KEYBOARD_NAME }}_vial.uf2
            vial-qmk/${{ env.KEYBOARD_NAME }}_vial.hex
            vial-qmk/${{ env.KEYBOARD_NAME }}_vial.bin
