name: Build QMK & Vial Firmware
on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  KEYBOARD_NAME: "tomtho"
  QMK_KEYMAP: "tomtho"
  VIAL_KEYMAP: "vial"
  USER_REPO_PATH: "tomtho-akdk/qmk_firmware"

jobs:
  build_firmware:
    name: Build QMK and Vial Firmware
    runs-on: ubuntu-latest
    container: qmkfm/qmk_cli:latest

    steps:
      - name: Checkout user repo
        uses: actions/checkout@v4
        with:
          path: qmk_firmware

      - name: Set up QMK environment
        run: |
          cd qmk_firmware
          qmk setup

      # ------------------------------
      # üîπ QMKÊ®ôÊ∫ñ„Éï„Ç°„Éº„É†„Ç¶„Çß„Ç¢„ÅÆ„Éì„É´„Éâ
      # ------------------------------
      - name: Build QMK firmware
        working-directory: qmk_firmware
        run: |
          echo "üîπ Building QMK firmware..."
          qmk compile -kb ${{ env.KEYBOARD_NAME }} -km ${{ env.QMK_KEYMAP }} || (echo "‚ùå QMK Build failed" && exit 1)
          mkdir -p artifacts/qmk
          find . -type f \( -name "*.hex" -o -name "*.bin" -o -name "*.uf2" \) -exec cp {} artifacts/qmk/ \;

      # ------------------------------
      # üîπ Vial QMK„Éï„Ç°„Éº„É†„Ç¶„Çß„Ç¢„ÅÆ„Éì„É´„Éâ
      # ------------------------------
      - name: Checkout Vial QMK
        uses: actions/checkout@v4
        with:
          repository: vial-kb/vial-qmk
          path: vial-qmk

      - name: Copy custom keyboard for Vial
        run: |
          mkdir -p vial-qmk/keyboards/${{ env.KEYBOARD_NAME }}
          cp -r qmk_firmware/keyboards/${{ env.KEYBOARD_NAME }}/* \
                vial-qmk/keyboards/${{ env.KEYBOARD_NAME }}/
          echo "‚úÖ Copied custom keyboard for Vial."

      - name: Build Vial firmware
        working-directory: vial-qmk
        run: |
          echo "üîπ Building Vial firmware..."
          make ${{ env.KEYBOARD_NAME }}:vial || (echo "‚ùå Vial Build failed" && exit 1)
          mkdir -p artifacts/vial
          find . -type f \( -name "${{ env.KEYBOARD_NAME }}_vial.*" -o -name "*.hex" -o -name "*.bin" -o -name "*.uf2" \) -exec cp {} artifacts/vial/ \;

      # ------------------------------
      # üîπ „Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
      # ------------------------------
      - name: Upload QMK firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KEYBOARD_NAME }}-qmk-firmware
          path: artifacts/qmk/

      - name: Upload Vial firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KEYBOARD_NAME }}-vial-firmware
          path: artifacts/vial/
