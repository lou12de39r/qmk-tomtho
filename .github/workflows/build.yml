name: Build QMK & Vial Firmware
on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  KEYBOARD_NAME: "tomtho"
  QMK_KEYMAP: "tomtho"
  VIAL_KEYMAP: "vial"
  USER_REPO_PATH: "tomtho-akdk/qmk_firmware/keyboards/tomtho"  # ‚Üê ÂÆüÈöõ„ÅÆÊßãÊàê„Å´Âêà„Çè„Åõ„Å¶Ë™øÊï¥

jobs:
  # ================================
  # üîπ QMKÊ®ôÊ∫ñ„Éï„Ç°„Éº„É†„Ç¶„Çß„Ç¢„ÅÆ„Éì„É´„Éâ
  # ================================
  build_qmk:
    name: Build QMK Firmware
    runs-on: ubuntu-latest
    container: qmkfm/qmk_cli:latest

    steps:
      - name: Checkout repository (user QMK firmware)
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Prepare QMK folder
        run: |
          echo "üß© Preparing QMK directory structure..."
          mkdir -p qmk_firmware/keyboards/${{ env.KEYBOARD_NAME }}
          cp -r repo/${{ env.USER_REPO_PATH }}/* qmk_firmware/keyboards/${{ env.KEYBOARD_NAME }}/
          echo "‚úÖ Copied keyboard sources to qmk_firmware/keyboards/${{ env.KEYBOARD_NAME }}/"
          ls -R qmk_firmware/keyboards/${{ env.KEYBOARD_NAME }} | head -n 30

      - name: Initialize QMK environment
        working-directory: qmk_firmware
        run: |
          qmk setup --yes
          qmk info -kb ${{ env.KEYBOARD_NAME }} || true

      - name: Build QMK firmware
        working-directory: qmk_firmware
        run: |
          echo "üîπ Building QMK firmware: keyboard=${{ env.KEYBOARD_NAME }}, keymap=${{ env.QMK_KEYMAP }}"
          qmk compile -kb ${{ env.KEYBOARD_NAME }} -km ${{ env.QMK_KEYMAP }} || (echo "‚ùå QMK Build failed" && exit 1)
          echo "=== QMK Build Complete ==="
          find . -type f \( -name "*.hex" -o -name "*.bin" -o -name "*.uf2" \) -print || true

      - name: Collect QMK artifacts
        working-directory: qmk_firmware
        run: |
          mkdir -p artifacts
          find . -type f \( -path "./.build/*" -o -name "*.hex" -o -name "*.bin" -o -name "*.uf2" \) -exec cp {} artifacts/ \; || true
          echo "Artifacts:"
          ls -la artifacts || true

      - name: Upload QMK firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KEYBOARD_NAME }}-qmk-firmware
          path: qmk_firmware/artifacts/

  # ================================
  # üîπ VialÁâà„Éï„Ç°„Éº„É†„Ç¶„Çß„Ç¢„ÅÆ„Éì„É´„Éâ
  # ================================
  build_vial:
    name: Build Vial Firmware
    runs-on: ubuntu-latest
    container: qmkfm/qmk_cli:latest

    steps:
      - name: Checkout Vial QMK repository
        uses: actions/checkout@v4
        with:
          repository: vial-kb/vial-qmk
          path: vial-qmk

      - name: Checkout user repository (source QMK files)
        uses: actions/checkout@v4
        with:
          path: user_repo

      - name: Copy custom keyboard into vial-qmk
        run: |
          echo "üß© Copying keyboard files..."
          mkdir -p vial-qmk/keyboards/${{ env.KEYBOARD_NAME }}
          cp -r user_repo/${{ env.USER_REPO_PATH }}/* vial-qmk/keyboards/${{ env.KEYBOARD_NAME }}/
          echo "‚úÖ Copied tomtho sources for Vial build"

      - name: Build Vial firmware
        working-directory: vial-qmk
        run: |
          echo "üîπ Building Vial firmware..."
          make ${{ env.KEYBOARD_NAME }}:vial || (echo "‚ùå Vial Build failed" && exit 1)
          echo "=== Vial Build Complete ==="
          find . -type f \( -name "${{ env.KEYBOARD_NAME }}_vial.*" -o -name "*.hex" -o -name "*.bin" -o -name "*.uf2" \) -print || true

      - name: Collect Vial artifacts
        working-directory: vial-qmk
        run: |
          mkdir -p artifacts
          find . -type f \( -name "${{ env.KEYBOARD_NAME }}_vial.*" -o -name "*.hex" -o -name "*.bin" -o -name "*.uf2" \) -exec cp {} artifacts/ \; || true
          ls -la artifacts || true

      - name: Upload Vial firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KEYBOARD_NAME }}-vial-firmware
          path: vial-qmk/artifacts/
