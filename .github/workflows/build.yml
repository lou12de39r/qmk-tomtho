name: Build Vial QMK Firmware
on:
  push:
    branches:
      - main
  workflow_dispatch:

# ここで変数を定義し、再利用しやすくする
env:
  KEYBOARD_NAME: "tomtho" # キーボード名。使用するキーボードに合わせて変更
  KEYBOARD_PATH: "keyboards/${{ env.KEYBOARD_NAME }}" # キーボード定義へのパス
  QMK_VARIANT: "vial" # ビルドするキーマップ名

jobs:
  build:
    runs-on: ubuntu-latest
    container: qmkfm/qmk_cli:latest
    steps:
      # 現在のリポジトリをチェックアウト
      - name: Checkout current repo
        uses: actions/checkout@v4
      
      # Vial QMKリポジトリをチェックアウト
      - name: Checkout Vial QMK Firmware
        uses: actions/checkout@v4
        with:
          repository: vial-kb/vial-qmk
          path: vial-qmk

      # 現在のリポジトリのキーボード定義をVial QMKにコピー
      - name: Copy custom keyboard
        run: |
          cp -r "${{ env.KEYBOARD_PATH }}" "vial-qmk/${{ env.KEYBOARD_PATH }}"

      # ファームウェアをビルド
      - name: Build Vial firmware
        working-directory: vial-qmk
        run: |
          qmk compile --keyboard ${{ env.KEYBOARD_NAME }} --keymap ${{ env.QMK_VARIANT }}
      
      # 成果物をアップロード
      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KEYBOARD_NAME }}-${{ env.QMK_VARIANT }}-firmware
          path: vial-qmk/${{ env.KEYBOARD_NAME }}_${{ env.QMK_VARIANT }}.*
